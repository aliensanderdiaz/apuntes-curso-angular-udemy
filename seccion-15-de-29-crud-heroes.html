<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sección 15 de 29 - CRUD Heroes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
</head>

<body>
  <div class="container mt-4">
    <div class="row">
      <div class="col">
        <h1>Sección 15 de 29 - CRUD Heroes</h1>
      </div>
    </div>
    <hr />
    <div class="row">
      <div class="col">
        <div class="list-group">
          <a href="./index.html" class="list-group-item list-group-item-action">
            Volver
          </a>
        </div>
      </div>
    </div>

    <hr>

    <section class="container">
      <h3>Sección 201 de 404 - Introducción a la sección</h3>

    </section>
    <hr>

    <section class="container">
      <h3>Sección 202 de 404 - Temas puntuales de la sección</h3>

    </section>
    <hr>

    <section class="container">
      <h3>Sección 203 de 404 - Demostración del Objetivo Final</h3>

    </section>
    <hr>

    <section class="container">
      <h3>Sección 204 de 404 - Continuación de la sección</h3>

    </section>
    <hr>

    <section class="container">
      <h3>Sección 205 de 404 - HerosService - CRUD endpoints</h3>
      <pre class="prettyprint">

                addHero(hero: Hero): Observable&ltHero> {
                    return this.http.post&ltHero>(`${this.baseUrl}/heroes`, hero)
                }

                updateHero(hero: Hero): Observable&ltHero> {
                    if (!hero.id) throw Error('Hero id is required')
                    return this.http.patch&ltHero>(`${this.baseUrl}/heroes/${hero.id}`, hero)
                }

                deleteHero(id: string): Observable&ltboolean> {
                    return this.http.delete(`${this.baseUrl}/heroes/${id}`)
                    .pipe(
                        catchError(err => of(false)),
                        map(resp => true)
                    )
                }
            </pre>
    </section>
    <hr>

    <section class="container">
      <h3>Sección 206 de 404 - HeroForm - ReactiveForms introducción</h3>
      <pre class="prettyprint">

                public heroForm = new FormGroup({
                    id: new FormControl<string>(''),
                    superhero: new FormControl<string>('', { nonNullable: true }),
                    publisher: new FormControl<Publisher>(Publisher.DCComics),
                    alter_ego: new FormControl(''),
                    first_appearance: new FormControl(''),
                    characters: new FormControl(''),
                    alt_img: new FormControl(''),
                })
            </pre>
    </section>
    <hr>

    <section class="container">
      <h3>Sección 207 de 404 - Conectar el formulario con el template</h3>
      <pre class="prettyprint">

                &lth1>
                Editar / Agregar
                héroe
                &ltsmall>Superman&lt/small>
              &lt/h1>
              
              &ltmat-divider class="mb-2">&lt/mat-divider>
              
              &ltdiv class="grid">
              
                &ltdiv class="col-12 sm:col-6">
                  &ltmat-card>
                    &ltmat-card-content>
              
                      &ltform class="grid" [formGroup]="heroForm" (ngSubmit)="onSubmit()">
              
                        &ltmat-form-field class="col-12 sm:col-6">
                          &ltmat-label>Super héroe&lt/mat-label>
                          &ltinput
                            matInput
                            type="text"
                            required
                            formControlName="superhero"
                          />
                        &lt/mat-form-field>
              
                        &ltmat-form-field class="col-12 sm:col-6">
                          &ltmat-label>Alter ego&lt/mat-label>
                          &ltinput
                            matInput
                            type="text"
                            required
                            formControlName="alter_ego"
                          />
                        &lt/mat-form-field>
              
              
                        &ltmat-form-field class="col-12">
                          &ltmat-label>Primera aparición&lt/mat-label>
                          &ltinput
                            matInput
                            type="text"
                            required
                            formControlName="first_appearance"
                          />
                        &lt/mat-form-field>
              
                        &ltmat-form-field class="col-12">
                          &ltmat-label>Personajes&lt/mat-label>
                          &ltinput
                            matInput
                            type="text"
                            required
                            formControlName="characters"
                          />
                        &lt/mat-form-field>
              
                        &ltmat-form-field class="col-12">
                          &ltmat-label>Creador&lt/mat-label>
                          &ltmat-select required
                          formControlName="publisher">
                            &ltmat-option *ngFor="let publisher of publishers"
                              [value]="publisher.id">
                              {{ publisher.desc }}
                            &lt/mat-option>
                          &lt/mat-select>
                        &lt/mat-form-field>
              
              
              
                        &ltmat-form-field class="col-12">
                          &ltmat-label>Alternative Image&lt/mat-label>
                          &ltinput
                            matInput
                            type="text"
                            formControlName="alt_img"
                          />
                        &lt/mat-form-field>
                      &lt/form>
              
                      &ltdiv class="flex justify-content-between">
                        &ltbutton
                          mat-flat-button
                          color="warn"
                        >
                          Borrar
                        &lt/button>
              
                        &ltbutton
                          mat-flat-button
                          color="primary"
                          (click)="onSubmit()"
                        >
                          &ltmat-icon>save&lt/mat-icon>
                          Guardar
                        &lt/button>
                      &lt/div>
              
                    &lt/mat-card-content>
                  &lt/mat-card>
                &lt/div>
              
                &ltdiv class="col-12 sm:col-6">
              
                  &ltmat-card>
                    &ltimg src="" alt="imagen del héroe" mat-card-image>
                  &lt/mat-card>
              
                &lt/div>
              &lt/div>
              
              
            </pre>
    </section>
    <hr>
    <section class="container">
      <h3>Sección 208 de 404 - Getters dentro del componente</h3>
      <pre class="prettyprint">

                  constructor(
                    private heroesService: HeroesService
                  ) {}
                
                  get currentHero(): Hero {
                    const hero = this.heroForm.value as Hero
                
                    return hero
                  }
                
                  onSubmit(): void {
                    if (this.heroForm.invalid) return
                
                    this.heroesService.updateHero( this.currentHero )
                  }
            </pre>

      <pre class="prettyprint">

              &ltdiv class="col-12 sm:col-6">

                &ltmat-card>
                  &ltimg [src]="currentHero | heroImage" alt="imagen del héroe" mat-card-image>
                &lt/mat-card>
              
              &lt/div>
              &lt/div>
              
              &ltpre>
              {{ currentHero | json }}
              &lt/pre>
            </pre>
    </section>
    <hr>

    <section class="container">
      <h3>Sección 209 de 404 - Actualizar y crear héroes</h3>
      <pre class="prettyprint">

                onSubmit(): void {
                    if (this.heroForm.invalid) return
                
                    if (this.currentHero.id) {
                      this.heroesService.updateHero( this.currentHero )
                        .subscribe( hero => {
                          // TODO: mostrar snackbar
                        })
                
                      return
                    }
                
                    this.heroesService.addHero( this.currentHero )
                      .subscribe( hero => {
                        // TODO: mostrar snackbar y navegar a /heroes/edit hero.id
                      })
                
                  }
            </pre>
    </section>
    <hr>

    <section class="container">
      <h3>Sección 210 de 404 - Establecer el valor del formulario</h3>

      <pre class="prettyprint">

                ngOnInit(): void {
                    if (!this.router.url.includes('edit')) return
                
                    this.activatedRoute.params
                      .pipe(
                        switchMap( ({ id }) => this.heroesService.getHeroeById( id ))
                      )
                      .subscribe( hero => {
                        if (!hero) return this.router.navigateByUrl('/')
                
                        this.heroForm.reset( hero )
                        return
                      })
                  }
            </pre>

    </section>
    <hr>

    <section class="container">
      <h3>Sección 211 de 404 - Snackbars y redirección</h3>
      <pre class="prettyprint">

                onSubmit(): void {
                    if (this.heroForm.invalid) return
                
                    if (this.currentHero.id) {
                      this.heroesService.updateHero(this.currentHero)
                        .subscribe(hero => {
                          this.showSnackBar(`${ hero.superhero } updated!`)
                        })
                
                        return
                      }
                
                      this.heroesService.addHero(this.currentHero)
                      .subscribe(hero => {
                        this.showSnackBar(`${ hero.superhero } created!`)
                        this.router.navigateByUrl(`/heroes/edit/${hero.id}`)
                      })
                
                  }
                
                  showSnackBar( message: string ): void {
                    this.snackBar.open( message, 'done', {
                      duration: 2500
                    })
                  }
            </pre>

      <pre class="prettyprint">

              &lth1>
                {{ currentHero.id ? 'Editar' : 'Agregar'}}
                héroe
                &ltsmall *ngIf="currentHero.id">{{ currentHero.superhero }}&lt/small>
              &lt/h1>
              
              &ltbutton
              *ngIf="currentHero.id"
                mat-flat-button
                color="warn"
              >
                Borrar
              &lt/button>
              
              
            </pre>
    </section>
    <hr>

    <section class="container">
        <h3>Sección 212 de 404 - Material Dialogs</h3>
        <pre class="prettyprint">
        
            > ng g c heroes/components/confirmDialog
        </pre>

        <pre class="prettyprint">
        
          export class ConfirmDialogComponent {
            constructor(
              public dialogRef: MatDialogRef&ltConfirmDialogComponent>,
              @Inject(MAT_DIALOG_DATA) public data: Hero
            ) {}
          
            onNoClick() {
              this.dialogRef.close(false)
            }
          
            onConfirm() {
              this.dialogRef.close(true)
            }
          }
        </pre>

        <pre class="prettyprint">
        
          &lth1 mat-dialog-title>¿Está seguro?&lt/h1>
          &ltdiv mat-dialog-content>
            &ltp>Este proceso no es reversible, está a punto de eliminar a HEROE&lt/p>
          &lt/div>
          &ltdiv mat-dialog-actions>
            &ltbutton mat-button mat-dialog-close (click)="onNoClick()">No&lt/button>
            &ltspan class="spacer">&lt/span>
            &ltbutton mat-button color="primary" mat-dialog-close cdkFocusInitial (click)="onConfirm()">Ok&lt/button>
          &lt/div>
          
        </pre>

        <pre class="prettyprint">
        
          onDeleteHero() {
            if (!this.currentHero.id) throw Error('Hero id is required')
        
            const dialogRef = this.dialog.open( ConfirmDialogComponent, {
              data: this.heroForm.value
            })
        
            dialogRef.afterClosed().subscribe( result => {
              if (result) {
                this.heroesService.deleteHero( this.currentHero.id )
                 .subscribe( hero => this.router.navigateByUrl('/'))
              }
            })
          }
        </pre>
    </section>
    <hr>

    <section class="container">
        <h3>Sección 213 de 404 - Código fuente de la sección</h3>

        <pre class="prettyprint">
        
          onDeleteHero() {
            if (!this.currentHero.id) throw Error('Hero id is required')
        
            const dialogRef = this.dialog.open( ConfirmDialogComponent, {
              data: this.heroForm.value
            })
        
            dialogRef.afterClosed()
              .pipe(
                filter( (result: boolean) => result ),
                switchMap( () => this.heroesService.deleteHero( this.currentHero.id )),
                filter( (wasDeleted: boolean) => wasDeleted )
              )
              .subscribe(() => {
                this.router.navigate(['/heroes'])
              })
        
            // dialogRef.afterClosed().subscribe( result => {
            //   if (result) {
            //     this.heroesService.deleteHero( this.currentHero.id )
            //      .subscribe( wasDeleted => {
            //       if (wasDeleted) {
            //         this.router.navigateByUrl('/')
            //       }
            //      })
            //   }
            // })
          }
        </pre>
        
    </section>
    <hr>

    <section class="container">
        <h3>Sección 214 de 404 - Códgio feunte de la sección</h3>
        <p>
          <a href="https://github.com/Klerith/angular-heroes-app/tree/fin-seccion-15">https://github.com/Klerith/angular-heroes-app/tree/fin-seccion-15</a>
        </p>
    </section>
    <hr>


































  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
    crossorigin="anonymous"></script>
</body>

</html>